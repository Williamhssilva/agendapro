generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANT: Estabelecimentos
// ============================================

model Estabelecimento {
  id        String   @id @default(cuid())
  slug      String   @unique // Para subdomain: salaobella.agendapro.com
  nome      String
  tipo      String   // salao, barbearia, clinica, esmalteria, spa
  
  // Contato
  email     String?
  telefone  String?
  endereco  String?
  cidade    String?
  estado    String?
  
  // Personalização (White-label)
  logoUrl   String?
  corPrimaria String @default("#4F46E5")
  
  // Plano e Billing
  planoId   String
  plano     Plano    @relation(fields: [planoId], references: [id])
  trialEndsAt DateTime?
  subscriptionStatus String @default("trial") // trial, active, cancelled, past_due
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relacionamentos
  usuarios       Usuario[]
  profissionais  Profissional[]
  servicos       Servico[]
  clientes       Cliente[]
  agendamentos   Agendamento[]
  configuracoes  Configuracao?

  @@index([slug])
}

// ============================================
// PLANOS (SaaS Tiers)
// ============================================

model Plano {
  id                    String   @id @default(cuid())
  nome                  String   // Básico, Profissional, Premium
  slug                  String   @unique
  precoMensal           Float
  limiteProfissionais   Int      // 2, 5, -1 (ilimitado)
  limiteNotificacoes    Int      // 100, -1 (ilimitado)
  temPersonalizacao     Boolean  @default(false)
  temDominioProprio     Boolean  @default(false)
  temAPI                Boolean  @default(false)
  ativo                 Boolean  @default(true)
  
  estabelecimentos Estabelecimento[]
  
  @@index([slug])
}

// ============================================
// USUÁRIOS (Donos/Admins do Estabelecimento)
// ============================================

model Usuario {
  id                String   @id @default(cuid())
  nome              String
  email             String   @unique
  emailVerified     DateTime?
  senha             String?  // hash bcrypt
  imagem            String?
  
  // OAuth
  googleId          String?  @unique
  
  // Relacionamento com Estabelecimento
  estabelecimentoId String
  estabelecimento   Estabelecimento @relation(fields: [estabelecimentoId], references: [id], onDelete: Cascade)
  
  // Permissões
  role              String   @default("admin") // admin, manager
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // NextAuth
  accounts          Account[]
  sessions          Session[]
  
  @@index([estabelecimentoId])
  @@index([email])
}

// ============================================
// NextAuth Models
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user Usuario @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         Usuario  @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// PROFISSIONAIS (Barbeiros, Cabeleireiras, etc)
// ============================================

model Profissional {
  id                String   @id @default(cuid())
  estabelecimentoId String
  estabelecimento   Estabelecimento @relation(fields: [estabelecimentoId], references: [id], onDelete: Cascade)
  
  nome              String
  email             String?
  telefone          String?
  especialidade     String?  // Cabeleireira, Barbeiro, Manicure, etc
  fotoUrl           String?
  
  // Horários de trabalho (JSON)
  horariosTrabalho  String?  // {"segunda": {"inicio": "09:00", "fim": "18:00"}, ...}
  
  ativo             Boolean  @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  agendamentos      Agendamento[]
  
  @@index([estabelecimentoId])
}

// ============================================
// SERVIÇOS
// ============================================

model Servico {
  id                String   @id @default(cuid())
  estabelecimentoId String
  estabelecimento   Estabelecimento @relation(fields: [estabelecimentoId], references: [id], onDelete: Cascade)
  
  nome              String
  descricao         String?
  categoria         String   // cabelo, barba, unhas, estetica, spa
  duracao           Int      // minutos
  preco             Float
  
  ativo             Boolean  @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  agendamentos      Agendamento[]
  
  @@index([estabelecimentoId])
  @@index([categoria])
}

// ============================================
// CLIENTES (Clientes dos Estabelecimentos)
// ============================================

model Cliente {
  id                String   @id @default(cuid())
  estabelecimentoId String
  estabelecimento   Estabelecimento @relation(fields: [estabelecimentoId], references: [id], onDelete: Cascade)
  
  nome              String
  telefone          String
  email             String?
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  agendamentos      Agendamento[]
  
  @@index([estabelecimentoId])
  @@index([telefone])
}

// ============================================
// AGENDAMENTOS
// ============================================

model Agendamento {
  id                String   @id @default(cuid())
  estabelecimentoId String
  estabelecimento   Estabelecimento @relation(fields: [estabelecimentoId], references: [id], onDelete: Cascade)
  
  // Relacionamentos
  clienteId         String
  cliente           Cliente @relation(fields: [clienteId], references: [id])
  
  servicoId         String
  servico           Servico @relation(fields: [servicoId], references: [id])
  
  profissionalId    String
  profissional      Profissional @relation(fields: [profissionalId], references: [id])
  
  // Data e Hora
  dataHora          DateTime
  duracao           Int      // minutos (copiado do serviço)
  
  // Status
  status            String   @default("pendente") // pendente, confirmado, concluido, cancelado, noshow
  
  // Observações
  observacoes       String?
  motivoCancelamento String?
  
  // Notificações
  emailEnviado      Boolean  @default(false)
  whatsappEnviado   Boolean  @default(false)
  lembreteEnviado   Boolean  @default(false)
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([estabelecimentoId])
  @@index([dataHora])
  @@index([status])
  @@index([profissionalId, dataHora])
  @@index([estabelecimentoId, dataHora])
  @@index([estabelecimentoId, profissionalId, dataHora])
}

// ============================================
// CONFIGURAÇÕES DO ESTABELECIMENTO
// ============================================

model Configuracao {
  id                String   @id @default(cuid())
  estabelecimentoId String   @unique
  estabelecimento   Estabelecimento @relation(fields: [estabelecimentoId], references: [id], onDelete: Cascade)
  
  // Horário de Funcionamento (JSON)
  horariosFuncionamento String? // {"segunda": {"aberto": true, "inicio": "09:00", "fim": "18:00"}, ...}
  
  // Intervalo entre agendamentos
  intervaloMinutos  Int      @default(0)
  
  // Antecedência mínima para agendamento
  antecedenciaMinima Int     @default(60) // minutos
  
  // Cancelamento
  permiteCancelamento Boolean @default(true)
  antecedenciaCancelamento Int @default(180) // 3 horas
  
  // Notificações
  enviarConfirmacao Boolean  @default(true)
  enviarLembrete    Boolean  @default(true)
  horasAntesLembrete Int     @default(24)
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

